{% extends 'base.html' %}
{% block body %}
<div class="container">
  <h1>{{ step.title }}</h1>

  {% if step.type == 'registration' %}
    <div class="grid">
      {% for u in users %}
        <div class="card">
          <div class="avatar">üë§</div>
          <div class="name">{{ u.name }}</div>
        </div>
      {% endfor %}
    </div>

  {% elif step.type == 'open' %}
    {% if phase == 0 %}
      <p class="question">{{ step.text }}</p>
      <p class="hint">–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–¥–µ–∏ –±–æ—Ç—É. –ó–¥–µ—Å—å –æ–Ω–∏ –ø–æ–∫–∞ –Ω–µ –≤–∏–¥–Ω—ã.</p>
    {% elif phase == 1 %}
      {% if ideas|length == 0 %}
        <p class="hint">–û—Ç–≤–µ—Ç–æ–≤ –Ω–µ—Ç.</p>
      {% else %}
        <ol>
        {% for idea in ideas %}
          <li><div class="idea">{{ idea.text }}</div>
              <div class="meta">–æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ {{ (idea.submitted_at - since).seconds }} —Å–µ–∫—É–Ω–¥</div></li>
        {% endfor %}
        </ol>
      {% endif %}
    {% elif phase == 2 %}
      <p class="question">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏–¥–µ–∏</p>
      <ol>
      {% for idea in ideas %}
        <li><div class="idea">{{ idea.text }}</div>
            <div class="meta">–æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ {{ (idea.submitted_at - since).seconds }} —Å–µ–∫—É–Ω–¥</div></li>
      {% endfor %}
      </ol>
      <div class="progress">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ (‚â•1): {{ voters_count }}
        {% if last_vote_ago_s is not none %} ‚Ä¢ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–ª–æ—Å {{ last_vote_ago_s }} —Å –Ω–∞–∑–∞–¥{% endif %}
      </div>
    {% elif phase == 3 %}
      <ol>
        {% for idea in ideas %}
        <li>
          <div class="idea">{{ idea.text }}</div>
          <div class="votes">–ì–æ–ª–æ—Å–∞: {{ (voters_map.get(idea.id) or [])|length }}</div>
        </li>
        {% endfor %}
      </ol>
    {% endif %}

  {% elif step.type == 'quiz' %}
    {% if phase == 0 %}
      <div class="question">{{ step.text }}</div>
      <ol>
        {% for opt in options %}
          <li>{{ opt.text }}</li>
        {% endfor %}
      </ol>
      <div class="hint">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–±–∏—Ä–∞—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤ –±–æ—Ç–µ.</div>
    {% else %}
      <div class="question">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <canvas id="mcqChart"></canvas>
      <script>
        window.__mcq = {
          labels: [{% for opt in options %}'{{ opt.text|replace("'", "\'") }}',{% endfor %}],
          counts: [{% for c in counts %}{{ c }},{% endfor %}],
          correct: {{ correct }}
        };
        document.addEventListener('DOMContentLoaded', () => window.renderMcq());
      </script>
    {% endif %}

  {% elif step.type == 'leaderboard' %}
    <table class="board">
      <thead><tr><th>#</th><th>–ò–º—è</th><th>–ë–∞–ª–ª—ã</th><th>–í—Ä–µ–º—è (—Å)</th></tr></thead>
      <tbody>
        {% for u in users %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.total_score }}</td>
            <td>{{ (u.total_answer_ms/1000)|round(1) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<script>
  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
  ws.onmessage = (ev) => { const msg = JSON.parse(ev.data); if (msg.type === 'reload') location.reload(); };
</script>
{% endblock %}
