{% extends 'base.html' %}
{% block body %}
<div class="container">
  <h1>{{ step.title }}</h1>

  {% if step.type == 'registration' %}
    <div class="grid">
      {% for u in users %}
        <div class="card">
          <div class="avatar">üë§</div>
          <div class="name">{{ u.name }}</div>
        </div>
      {% endfor %}
    </div>

  {% elif step.type == 'open' %}
    {% if phase == 0 %}
      <p class="question">{{ step.text }}</p>
      <p class="hint">–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–¥–µ–∏ –±–æ—Ç—É. –ó–¥–µ—Å—å –æ–Ω–∏ –ø–æ–∫–∞ –Ω–µ –≤–∏–¥–Ω—ã.</p>
      <div class="progress">–û—Ç–≤–µ—Ç–æ–≤: <span id="answersCount">{{ ideas|length }}</span> / {{ total_users }}{% if last_answer_ago_s is not none %} ‚Ä¢ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç <span id="lastAnswerAgo">{{ last_answer_ago_s }}</span>{% else %} ‚Ä¢ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç <span id="lastAnswerAgo">-</span>{% endif %}</div>
      <div class="timer" id="ideaTimer">05:00</div>
    {% elif phase == 1 %}
      <p class="question">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏–¥–µ–∏</p>
      <ol>
      {% for idea in ideas %}
        <li><div class="idea">{{ idea.text }}</div>
            <div class="meta">–æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ {{ (idea.submitted_at - since).seconds }} —Å–µ–∫—É–Ω–¥</div></li>
      {% endfor %}
      </ol>
      <div class="progress">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: <span id="votesCount">{{ voters_count }}</span>{% if last_vote_ago_s is not none %} ‚Ä¢ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–ª–æ—Å <span id="lastVoteAgo">{{ last_vote_ago_s }}</span>{% else %} ‚Ä¢ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–ª–æ—Å <span id="lastVoteAgo">-</span>{% endif %}</div>
      <div class="timer" id="voteTimer">01:00</div>
    {% elif phase == 2 %}
      <ol>
        {% for idea in ideas %}
        <li>
          <div class="idea">{{ idea.text }}</div>
          <div class="votes">–ì–æ–ª–æ—Å–∞: {{ (voters_map.get(idea.id) or [])|length }}</div>
        </li>
        {% endfor %}
      </ol>
    {% endif %}

  {% elif step.type == 'quiz' %}
    {% if phase == 0 %}
      <div class="question">{{ step.text }}</div>
      <ol>
        {% for opt in options %}
          <li>{{ opt.text }}</li>
        {% endfor %}
      </ol>
      <div class="hint">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–±–∏—Ä–∞—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤ –±–æ—Ç–µ.</div>
    {% else %}
      <div class="question">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <canvas id="mcqChart"></canvas>
      <script>
        window.__mcq = {
          labels: [{% for opt in options %}'{{ opt.text|replace("'", "\'") }}',{% endfor %}],
          counts: [{% for c in counts %}{{ c }},{% endfor %}],
          correct: {{ correct }}
        };
        document.addEventListener('DOMContentLoaded', () => window.renderMcq());
      </script>
    {% endif %}

  {% elif step.type == 'leaderboard' %}
    <table class="board">
      <thead><tr><th>#</th><th>–ò–º—è</th><th>–ë–∞–ª–ª—ã</th><th>–í—Ä–µ–º—è (—Å)</th></tr></thead>
      <tbody>
        {% for u in users %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.total_score }}</td>
            <td>{{ (u.total_answer_ms/1000)|round(1) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <div class="controls">
    <button onclick="post('/api/prev')">‚óÄÔ∏è Prev</button>
    <button onclick="post('/api/next')">Next ‚ñ∂Ô∏è</button>
    <button onclick="if(confirm('Reset DB?')) post('/api/reset')">Reset DB</button>
  </div>
</div>

<script>
  async function post(url){
    await fetch(url, {method:'POST'});
  }
  function formatAgo(sec){
    if(sec==null || sec==='-' || sec==='') return '-';
    sec = parseInt(sec);
    if(isNaN(sec)) return '-';
    if(sec >= 60){ const m=Math.floor(sec/60); const s=sec%60; return m+' –º–∏–Ω '+s+' —Å'; }
    return sec+' —Å';
  }
  const timerEl = document.getElementById('ideaTimer') || document.getElementById('voteTimer');
  if (timerEl){
    const start = new Date('{{ since.isoformat() }}Z').getTime();
    const duration = timerEl.id === 'ideaTimer' ? 5*60*1000 : 60*1000;
    function tick(){
      let left = duration - (Date.now() - start);
      if(left < 0) left = 0;
      const m = String(Math.floor(left/60000)).padStart(2,'0');
      const s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
      timerEl.textContent = m+':'+s;
    }
    setInterval(tick,1000); tick();
  }
  const lastAnswerEl = document.getElementById('lastAnswerAgo');
  const lastVoteEl = document.getElementById('lastVoteAgo');
  let lastAnswerSec = lastAnswerEl ? parseInt(lastAnswerEl.textContent) : null;
  let lastVoteSec = lastVoteEl ? parseInt(lastVoteEl.textContent) : null;
  if (isNaN(lastAnswerSec)) lastAnswerSec = null;
  if (isNaN(lastVoteSec)) lastVoteSec = null;
  if (lastAnswerEl) lastAnswerEl.textContent = formatAgo(lastAnswerSec);
  if (lastVoteEl) lastVoteEl.textContent = formatAgo(lastVoteSec);
  setInterval(() => {
    if (lastAnswerSec !== null){ lastAnswerSec++; lastAnswerEl.textContent = formatAgo(lastAnswerSec); }
    if (lastVoteSec !== null){ lastVoteSec++; lastVoteEl.textContent = formatAgo(lastVoteSec); }
  }, 1000);
  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    if (msg.type === 'reload') location.reload();
    if (msg.type === 'idea_progress'){
      const cnt = document.getElementById('answersCount');
      if (cnt) cnt.textContent = msg.count;
      if (lastAnswerEl && msg.last !== undefined){ lastAnswerSec = msg.last; lastAnswerEl.textContent = formatAgo(lastAnswerSec); }
    }
    if (msg.type === 'vote_progress'){
      const vcnt = document.getElementById('votesCount');
      if (vcnt) vcnt.textContent = msg.count;
      if (lastVoteEl && msg.last !== undefined){ lastVoteSec = msg.last; lastVoteEl.textContent = formatAgo(lastVoteSec); }
    }
  };
</script>
{% endblock %}
