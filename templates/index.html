<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TRIZ-Quiz Projector</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    #title { font-size: 2rem; margin-bottom: 1rem; }
    #content { font-size: 1.3rem; white-space: pre-wrap; }
    .highlight { background: #ffd; padding: 0.2rem 0.4rem; border-radius: 4px; }
    #results { margin-top: 2rem; }
    #participants { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; }
    .participant { text-align: center; font-size: 0.9rem; }
    .participant img { width: 80px; height: 80px; object-fit: cover; }
  </style>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div id="title">Ожидание начала…</div>
  <div id="content"></div>
  <div id="timer" style="margin-top:1rem; font-size:1.2rem; display:none"></div>
  <div id="answerStats" style="margin-top:0.5rem; display:none"></div>
  <div id="lastAnswer" style="margin-top:0.5rem; display:none"></div>
  <div id="participants"></div>
  <button id="startBtn">Начать</button>
  <button id="nextBtn" style="display:none">Далее</button>
  <div id="results"></div>

<script>
const socket = io();

function formatTime(sec) {
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

let timerId, sinceId, lastTs = Date.now();

function hideProgress() {
  ['timer','answerStats','lastAnswer'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  clearInterval(timerId);
  clearInterval(sinceId);
}

function startTimer() {
  clearInterval(timerId);
  let remaining = 300;
  const div = document.getElementById('timer');
  div.style.display = 'block';
  div.textContent = formatTime(remaining);
  timerId = setInterval(() => {
    remaining--;
    if (remaining < 0) { clearInterval(timerId); return; }
    div.textContent = formatTime(remaining);
  }, 1000);
}

function updateSince(ts) {
  lastTs = ts * 1000;
  clearInterval(sinceId);
  const div = document.getElementById('lastAnswer');
  div.style.display = 'block';
  sinceId = setInterval(() => {
    const diff = Math.floor((Date.now() - lastTs) / 1000);
    div.textContent = `Последний ответ: ${formatTime(diff)} назад`;
  }, 1000);
}

socket.on('step', step => {
  document.getElementById('title').textContent = step.title;
  if (step.type === 'quiz') {
    document.getElementById('content').textContent = step.options.join("\n");
  } else if (step.type === 'open' || step.type === 'vote') {
    document.getElementById('content').textContent = step.description || '';
  } else if (step.type === 'slide') {
    document.getElementById('content').textContent = step.content || '';
  }
  document.getElementById('results').innerHTML = '';
  if (['quiz','open','vote'].includes(step.type)) {
    startTimer();
  } else {
    hideProgress();
  }
});

socket.on('progress', data => {
  if (data.inactive) {
    hideProgress();
    return;
  }
  document.getElementById('answerStats').style.display = 'block';
  document.getElementById('answerStats').textContent = `Ответов: ${data.answered}/${data.total}`;
  updateSince(data.ts);
});

socket.on('votes_result', tally => {
  const div = document.getElementById('results');
  div.innerHTML = '<h2>Результаты голосования</h2>';
  for (const [name, cnt] of Object.entries(tally)) {
    div.innerHTML += `<div>${name}: <span class="highlight">${cnt}</span></div>`;
  }
});

socket.on('quiz_result', data => {
  document.getElementById('results').innerHTML =
    `<h2>Верный ответ: <span class="highlight">${data.correct}</span></h2>`;
});

socket.on('rating', rating => {
  const div = document.getElementById('results');
  div.innerHTML = '<h2>Итоговый рейтинг</h2>';
  rating.forEach(p => {
    div.innerHTML += `<div>${p.name}: <span class="highlight">${p.score}</span></div>`;
  });
});

socket.on('participants', data => {
  const div = document.getElementById('participants');
  div.innerHTML = '';
  data.who.forEach(p => {
    div.innerHTML += `<div class="participant"><img src="/avatar/${p.id}"/><div>${p.name}</div></div>`;
  });
});

document.getElementById('startBtn').addEventListener('click', async () => {
  await fetch('/start', {method: 'POST'});
});

document.getElementById('nextBtn').addEventListener('click', async () => {
  await fetch('/next', {method: 'POST'});
});

socket.on('started', () => {
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'inline-block';
  document.getElementById('participants').style.display = 'none';
  hideProgress();
});

socket.on('end', () => {
  document.getElementById('nextBtn').style.display = 'none';
  hideProgress();
});

socket.on('reset', () => {
  document.getElementById('startBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('participants').style.display = 'grid';
  document.getElementById('title').textContent = 'Ожидание начала…';
  document.getElementById('content').textContent = '';
  document.getElementById('results').innerHTML = '';
  hideProgress();
});
</script>
</body>
</html>
