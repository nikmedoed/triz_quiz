<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>TRIZ-Quiz Projector</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 1rem;
        }

        #title {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        #content {
            font-size: 1.3rem;
            white-space: pre-wrap;
        }

        .highlight {
            background: #ffd;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        #results {
            margin-top: 2rem;
        }

        #participants {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .participant {
            text-align: center;
            font-size: 0.9rem;
        }

        .participant img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
<div id="title">Ожидание начала…</div>
<div id="content"></div>
<div id="timer" style="margin-top:1rem; font-size:1.2rem; display:none"></div>
<div id="answerStats" style="margin-top:0.5rem; display:none"></div>
<div id="lastAnswer" style="margin-top:0.5rem; display:none"></div>
<div id="participants"></div>
<button id="startBtn">Начать</button>
<button id="nextBtn" style="display:none">Далее</button>
<button id="resetBtn">Сбросить базу</button>
<div id="results"></div>

<script>
    const socket = io();

    function formatTime(sec) {
        const m = String(Math.floor(sec / 60)).padStart(2, '0');
        const s = String(sec % 60).padStart(2, '0');
        return `${m}:${s}`;
    }

    let timerId, sinceId, lastTs = Date.now();

    function hideProgress() {
        ['timer', 'answerStats', 'lastAnswer'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        clearInterval(timerId);
        clearInterval(sinceId);
    }

    function startTimer(seconds) {
        clearInterval(timerId);
        let remaining = seconds;
        const div = document.getElementById('timer');
        div.style.display = 'block';
        const tick = () => {
            div.textContent = formatTime(remaining);
            remaining--;
            if (remaining < 0) clearInterval(timerId);
        };
        tick();
        timerId = setInterval(tick, 1000);
    }

    function updateSince(ts) {
        lastTs = ts * 1000;
        clearInterval(sinceId);
        const div = document.getElementById('lastAnswer');
        div.style.display = 'block';
        const tick = () => {
            const diff = Math.floor((Date.now() - lastTs) / 1000);
            div.textContent = `Последний ответ: ${formatTime(diff)} назад`;
        };
        tick();
        sinceId = setInterval(tick, 1000);
    }

    socket.on('step', step => {
        document.getElementById('title').textContent = step.title;
        if (step.type === 'quiz') {
            document.getElementById('content').textContent =
                step.options.map((o, i) => `${i + 1}. ${o}`).join("\n");
        } else if (step.type === 'open') {
            document.getElementById('content').textContent = step.description || '';
        } else if (step.type === 'vote') {
            if (step.ideas.length) {
                const txt = step.ideas.map(i => `${i.id}. ${i.text} (${formatTime(Math.floor(i.time))})`).join("\n");
                document.getElementById('content').textContent = txt;
            } else {
                document.getElementById('content').textContent = 'нет ответов';
            }
        } else if (step.type === 'slide') {
            document.getElementById('content').textContent = step.content || '';
        }
        document.getElementById('results').innerHTML = '';
        if (['quiz', 'open', 'vote'].includes(step.type) && !(step.type === 'vote' && !step.ideas.length)) {
            const secs = step.type === 'open' ? 300 : 60;
            startTimer(secs);
        } else {
            hideProgress();
        }
    });

    socket.on('progress', data => {
        if (data.inactive) {
            hideProgress();
            return;
        }
        document.getElementById('answerStats').style.display = 'block';
        document.getElementById('answerStats').textContent = `Ответов: ${data.answered}/${data.total}`;
        if (data.ts) {
            updateSince(data.ts);
        } else {
            clearInterval(sinceId);
            const div = document.getElementById('lastAnswer');
            div.style.display = 'block';
            div.textContent = 'Последний ответ: —';
        }
    });

    socket.on('vote_result', data => {
        const div = document.getElementById('content');
        let html = '';
        data.ideas.forEach(idea => {
            html += `<div style="margin-bottom:1rem"><strong>${idea.id}. ${idea.text}</strong> ` +
                `<span class="highlight">${idea.votes.length}</span> ` +
                `<span style="color:#666">(${formatTime(Math.floor(idea.time))})</span><br/>` +
                `<img src="/avatar/${idea.author.id}" width="40" height="40"/> ${idea.author.name}`;
            if (idea.votes.length) {
                html += '<div>';
                idea.votes.forEach(v => {
                    html += `<img src="/avatar/${v}" width="24" height="24"/>`;
                });
                html += '</div>';
            }
            html += '</div>';
        });
        div.innerHTML = html;
    });

    socket.on('quiz_result', data => {
        document.getElementById('content').textContent = '';
        const div = document.getElementById('results');
        div.innerHTML = '<h2>Результаты</h2>';
        data.options.forEach(opt => {
            const count = opt.voters.length;
            let row = `<div style="margin-bottom:1rem">${opt.id}. ${opt.text}<br/>` +
                `<div style="background:#ddd;width:${count * 40}px;height:20px"></div>` +
                `<div><span class="highlight">${count}</span>`;
            opt.voters.forEach(v => {
                row += ` <img src="/avatar/${v}" width="24" height="24"/>`;
            });
            row += '</div></div>';
            if (String(opt.id) === String(data.correct)) {
                row = `<div class="highlight">${row}</div>`;
            }
            div.innerHTML += row;
        });
    });

    socket.on('rating', rating => {
        document.getElementById('title').textContent = 'Итоговый рейтинг';
        document.getElementById('content').textContent = '';
        const div = document.getElementById('results');
        let html = '';
        rating.forEach(p => {
            html += `<div style="display:flex;align-items:center;margin-bottom:0.5rem">` +
                `<div style="width:2rem">${p.place}</div>` +
                `<img src="/avatar/${p.id}" width="40" height="40"/>` +
                `<div style="flex:1;margin-left:0.5rem">${p.name}</div>` +
                `<div class="highlight">${p.score}</div>` +
                `</div>`;
        });
        div.innerHTML = html;
    });

    socket.on('participants', data => {
        const div = document.getElementById('participants');
        div.innerHTML = '';
        data.who.forEach(p => {
            div.innerHTML += `<div class="participant"><img src="/avatar/${p.id}"/><div>${p.name}</div></div>`;
        });
    });

    document.getElementById('startBtn').addEventListener('click', async () => {
        await fetch('/start', {method: 'POST'});
    });

    document.getElementById('nextBtn').addEventListener('click', async () => {
        await fetch('/next', {method: 'POST'});
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        window.location.href = '/reset';
    });

    socket.on('started', () => {
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('participants').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        hideProgress();
    });

    socket.on('end', () => {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'inline-block';
        hideProgress();
    });

    socket.on('reset', () => {
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'inline-block';
        document.getElementById('participants').style.display = 'grid';
        document.getElementById('title').textContent = 'Ожидание начала…';
        document.getElementById('content').textContent = '';
        document.getElementById('results').innerHTML = '';
        hideProgress();
    });
</script>
</body>
</html>
